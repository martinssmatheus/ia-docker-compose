<!DOCTYPE html>
<html>
<head>
     <title>Chat - Leveduca</title>
     <link rel="stylesheet" type="text/css" href="/css/style.css" />
</head>
<body>
    <!-- <div id="acesso_usuario">
        <form id="login">
            <input type="text" placeholder="Insira seu apelido" name="apelido" id="apelido" />
            <input type="submit" value="Entrar" />
        </form>
    </div> -->
    <div style="padding: 20px;">
        <div id="sala_chat">
            <div id="conversa">
                <div id="historico_mensagens"></div>
                <select multiple="multiple" id="lista_usuarios"><option value="">Todos</option></select>
            </div>
            <form id='chat'>
                <select name="models" id="models">
                    <option value="llama3">Lhama</option>
                    <option value="deepseek-r1">Deepseek</option>
                    <option value="deepseek-coder">Deepseek Coder</option>
                  </select>
                <input type="text" id="texto_mensagem" name="texto_mensagem" />
                <input type="submit" id="enviar" value="Enviar" />
            </form>
        </div>
    </div>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect();
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const sala = urlParams.get('sala');
        const token = urlParams.get('token');
        
        var mensagens = [];

        if(localStorage.getItem('mensagens' + sala) != null) {
            mensagens = JSON.parse(localStorage.getItem('mensagens' + sala));
        }

        mensagens.forEach(mensagem => {
            adicionarMensagem(mensagem);
        });

        socket.emit(
                    "entrar", 
                    {
                        sala: sala,
                        token: token
                    }, 
                    function(valido){
                        if(valido){
                            $("#acesso_usuario").hide();
                            $("#sala_chat").show();
                            $("#sala_chat").css('display', 'grid');
                        }else{
                            $("#acesso_usuario").val("");
                            alert("Nome j√° utilizado nesta sala");
                        }
                    }
                );


        $("form#chat").submit(function(e) {
            e.preventDefault();
            socket.emit(
                "enviar mensagem", 
                {
                    mensagem: $(this).find("#texto_mensagem").val(),
                    sala: sala,
                    modelo: $(this).find("#models").val()
                },
                function () {
                    $("form#chat #texto_mensagem").val("");
                }
            );
        });

        socket.on("atualizar mensagens" + sala, 
            function(mensagem){
                adicionarMensagem(mensagem);
                
                mensagens.push(mensagem);
                localStorage.setItem('mensagens' + sala, JSON.stringify(mensagens));
            }
        );

        socket.on(
            "atualizar usuarios" + sala, 
            function(usuarios){
                $("#lista_usuarios").empty();
                $.each(
                    usuarios, 
                    function(indice) {
                        var opcao_usuario = $("<option />").text(usuarios[indice].split(" ")[0]);
                        $("#lista_usuarios").append(opcao_usuario);
                    }
                );
            }
        );

        function adicionarMensagem(mensagem) {
            var mensagem_formatada = $("<div style='display: flex' />");
            var apelido = mensagem.apelido.split(" ")[0];

            if(mensagem.ia == true) {
                apelido = mensagem.apelido;
            }

            mensagem_formatada.append($("<img class='avatar' src='" + mensagem.avatar + "' /> <p><strong>["+ mensagem.horario +"] "+ apelido +"</strong>: " + mensagem.mensagem + "<p />"));

            $("#historico_mensagens").append(mensagem_formatada);
            document.getElementById('historico_mensagens').scrollTo(0, 1000000);
        }
     </script>
</body>
</html>